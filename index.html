<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jeromeetienne/AR.js@1.7.2/aframe/build/aframe-ar.min.js"></script>
    <script src="https://rawgit.com/nicolocarpignoli/AR.js/master/aframe/build/aframe-gps-camera.min.js"></script>
    <style>
      /* é»‘è‰²é®ç½©ï¼Œç›´åˆ° GPS å®šä½æˆåŠŸ */
      #black-screen {
        position: fixed;
        width: 100%;
        height: 100%;
        background: black;
        color: white;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      /* æ’­æ”¾æŒ‰éˆ• */
      #play-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 15px 30px;
        font-size: 18px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1000;
        display: none;
      }

      /* éš±è— WebAR å ´æ™¯ç›´åˆ° GPS å®šä½æˆåŠŸ */
      #ar-container {
        display: none;
      }
    </style>
  </head>
  <body style="margin: 0; overflow: hidden">
    <!-- é»‘è‰²é®ç½©ï¼Œç›´åˆ° GPS å®šä½æˆåŠŸ -->
    <div id="black-screen">æ­£åœ¨å®šä½ä¸­...</div>

    <button id="play-button">é»æ“Šæ’­æ”¾å½±ç‰‡</button>

    <!-- WebAR å®¹å™¨ï¼ˆå…ˆéš±è—ï¼Œç­‰ GPS æˆåŠŸå¾Œæ‰é¡¯ç¤ºï¼‰ -->
    <div id="ar-container">
      <a-scene
        embedded
        arjs="sourceType: webcam; videoTexture: true; trackingMethod: best; debugUIEnabled: false;"
      >
        <a-video
          id="ar-video"
          src="https://stupendous-fudge-84cc56.netlify.app/0317.mp4"
          position="0 2 -3"
          width="3"
          height="1.5"
          autoplay
          loop
          playsinline
          muted
          preload="auto"
        >
        </a-video>
        <a-camera gps-camera rotation-reader></a-camera>
      </a-scene>
    </div>

    <script>
      let isGPSSet = false;

      function enableGPS() {
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              if (!isGPSSet) {
                let userLat = position.coords.latitude;
                let userLng = position.coords.longitude;

                console.log("ğŸ“ GPS è®€å–æˆåŠŸ:", userLat, userLng);

                let arVideo = document.getElementById("ar-video");

                // **ç¢ºä¿ GPS è¨­å®šæ­£ç¢º**
                setTimeout(() => {
                  arVideo.setAttribute(
                    "gps-entity-place",
                    `latitude: ${userLat}; longitude: ${userLng}`
                  );
                  arVideo.setAttribute("visible", "true"); // é¡¯ç¤ºå½±ç‰‡
                  console.log("ğŸ¥ å½±ç‰‡æ‡‰è©²å·²é¡¯ç¤º");
                }, 2000); // å»¶é² 2 ç§’ï¼Œç¢ºä¿ GPS ä½ç½®ç©©å®š

                // ç§»é™¤é»‘è‰²é®ç½©
                document.getElementById("black-screen").style.display = "none";

                // é¡¯ç¤º WebAR
                document.getElementById("ar-container").style.display = "block";

                // é¡¯ç¤ºæ’­æ”¾æŒ‰éˆ•
                document.getElementById("play-button").style.display = "block";

                isGPSSet = true; // ç¢ºä¿ä¸æœƒé‡è¤‡è¨­å®š GPS
              }
            },
            function (error) {
              console.error("âš ï¸ GPS ç„¡æ³•å•Ÿç”¨", error);
              alert("è«‹å…è¨± GPS å­˜å–ä»¥é¡¯ç¤º WebAR å½±ç‰‡ï¼");
            },
            { enableHighAccuracy: true, maximumAge: 60000, timeout: 10000 }
          );
        } else {
          alert("æ‚¨çš„è£ç½®ä¸æ”¯æ´ GPS");
        }
      }

      document
        .getElementById("play-button")
        .addEventListener("click", function () {
          let video = document.getElementById("ar-video");
          video.muted = false; // è§£é™¤éœéŸ³
          video.setAttribute("visible", "true"); // ç¢ºä¿å½±ç‰‡é¡¯ç¤º

          // ç­‰å¾… 500ms ç¢ºä¿å½±ç‰‡è¼‰å…¥
          setTimeout(() => {
            if (video.play) {
              video
                .play()
                .then(() => {
                  console.log("ğŸ¥ å½±ç‰‡æ’­æ”¾æˆåŠŸ");
                })
                .catch((error) => {
                  console.log("âŒ å½±ç‰‡ç„¡æ³•æ’­æ”¾:", error);
                });
            } else {
              console.log("âš ï¸ `video.play` æ–¹æ³•ä¸å­˜åœ¨ï¼Œå½±ç‰‡å¯èƒ½æœªè¼‰å…¥");
            }
          }, 500);

          this.style.display = "none"; // **éš±è—æŒ‰éˆ•**
        });

      // **å•Ÿå‹• GPS å®šä½**
      window.onload = function () {
        enableGPS();
      };
    </script>
  </body>
</html>
