<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/jeromeetienne/AR.js@1.7.2/aframe/build/aframe-ar.min.js"></script>
    <script src="https://rawgit.com/nicolocarpignoli/AR.js/master/aframe/build/aframe-gps-camera.min.js"></script>
    <style>
      /* 黑色遮罩，直到 GPS 定位成功 */
      #black-screen {
        position: fixed;
        width: 100%;
        height: 100%;
        background: black;
        color: white;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      /* 播放按鈕 */
      #play-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 15px 30px;
        font-size: 18px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        z-index: 1000;
        display: none;
      }

      /* 隱藏 WebAR 場景直到 GPS 定位成功 */
      #ar-container {
        display: none;
      }
    </style>
  </head>
  <body style="margin: 0; overflow: hidden">
    <!-- 黑色遮罩，直到 GPS 定位成功 -->
    <div id="black-screen">正在定位中...</div>

    <button id="play-button">點擊播放影片</button>

    <!-- WebAR 容器（先隱藏，等 GPS 成功後才顯示） -->
    <div id="ar-container">
      <a-scene
        embedded
        arjs="sourceType: webcam; videoTexture: true; trackingMethod: best; debugUIEnabled: false;"
      >
        <a-video
          id="ar-video"
          src="https://stupendous-fudge-84cc56.netlify.app/0317.mp4"
          position="0 2 -3"
          width="3"
          height="1.5"
          autoplay
          loop
          playsinline
          muted
          preload="auto"
        >
        </a-video>
        <a-camera gps-camera rotation-reader></a-camera>
      </a-scene>
    </div>

    <script>
      let isGPSSet = false;

      function enableGPS() {
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              if (!isGPSSet) {
                let userLat = position.coords.latitude;
                let userLng = position.coords.longitude;

                console.log("📍 GPS 讀取成功:", userLat, userLng);

                let arVideo = document.getElementById("ar-video");

                // **確保 GPS 設定正確**
                setTimeout(() => {
                  arVideo.setAttribute(
                    "gps-entity-place",
                    `latitude: ${userLat}; longitude: ${userLng}`
                  );
                  arVideo.setAttribute("visible", "true"); // 顯示影片
                  console.log("🎥 影片應該已顯示");
                }, 2000); // 延遲 2 秒，確保 GPS 位置穩定

                // 移除黑色遮罩
                document.getElementById("black-screen").style.display = "none";

                // 顯示 WebAR
                document.getElementById("ar-container").style.display = "block";

                // 顯示播放按鈕
                document.getElementById("play-button").style.display = "block";

                isGPSSet = true; // 確保不會重複設定 GPS
              }
            },
            function (error) {
              console.error("⚠️ GPS 無法啟用", error);
              alert("請允許 GPS 存取以顯示 WebAR 影片！");
            },
            { enableHighAccuracy: true, maximumAge: 60000, timeout: 10000 }
          );
        } else {
          alert("您的裝置不支援 GPS");
        }
      }

      document
        .getElementById("play-button")
        .addEventListener("click", function () {
          let video = document.getElementById("ar-video");
          video.muted = false; // 解除靜音
          video.setAttribute("visible", "true"); // 確保影片顯示

          // 等待 500ms 確保影片載入
          setTimeout(() => {
            if (video.play) {
              video
                .play()
                .then(() => {
                  console.log("🎥 影片播放成功");
                })
                .catch((error) => {
                  console.log("❌ 影片無法播放:", error);
                });
            } else {
              console.log("⚠️ `video.play` 方法不存在，影片可能未載入");
            }
          }, 500);

          this.style.display = "none"; // **隱藏按鈕**
        });

      // **啟動 GPS 定位**
      window.onload = function () {
        enableGPS();
      };
    </script>
  </body>
</html>
