<!DOCTYPE html>
<html>
  <head>
    <title>WebAR 建築物前播放影片</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://rawgit.com/nicolocarpignoli/AR.js/master/aframe/build/aframe-ar.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8tIJYmXx7fxn6ulAg-SMMC86oGgvSHFg"></script>

    <style>
      #map {
        height: 400px;
        width: 100%;
      }
    </style>
  </head>
  <body style="margin: 0; overflow: hidden">
    <!-- 顯示 Google 地圖 -->
    <div id="map"></div>

    <!-- WebAR 場景 -->
    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
      <a-video
        id="ar-video"
        src="https://peppy-marshmallow-c47b19.netlify.app/0317.mp4"
        position="0 1 -2"
        width="3"
        height="1.5"
        autoplay
        loop
      >
      </a-video>
      <a-camera gps-camera rotation-reader></a-camera>
    </a-scene>

    <script>
      async function checkCameraPermission() {
        try {
          const permissionStatus = await navigator.permissions.query({
            name: "camera",
          });

          if (permissionStatus.state === "granted") {
            console.log("✅ 相機權限已允許");
          } else if (permissionStatus.state === "denied") {
            alert(
              "❌ 相機權限被拒絕！\n請手動開啟：\nChrome: 設定 → 網站設定 → 相機\nSafari: 設定 → Safari → 相機權限"
            );
          } else {
            requestCameraAccess(); // 重新請求相機存取權限
          }
        } catch (error) {
          console.error("無法檢查權限", error);
          requestCameraAccess();
        }
      }

      function requestCameraAccess() {
        navigator.mediaDevices
          .getUserMedia({ video: true })
          .then(function (stream) {
            console.log("✅ 相機權限已允許");
          })
          .catch(function (err) {
            console.error("❌ 相機存取被拒絕", err);
            alert("請允許相機存取，以顯示 WebAR！");
          });
      }

      window.onload = function () {
        checkCameraPermission();
      };
      function initMap() {
        var location = { lat: 24.969812026015507, lng: 121.26015417116461 };
        var map = new google.maps.Map(document.getElementById("map"), {
          zoom: 18,
          center: location,
        });
        var marker = new google.maps.Marker({
          position: location,
          map: map,
        });
      }
      window.onload = initMap;

      // **確保 GPS 位置正確啟動**
      function enableGPS() {
        if ("geolocation" in navigator) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              let userLat = position.coords.latitude;
              let userLng = position.coords.longitude;

              console.log("GPS 啟動成功:", userLat, userLng);

              // **加入 ±0.0001 到 ±0.0002 的誤差**
              let latOffset = Math.random() * 0.0002 - 0.0001; // ±10~20m
              let lngOffset = Math.random() * 0.0002 - 0.0001; // ±10~20m

              let adjustedLat = userLat + latOffset;
              let adjustedLng = userLng + lngOffset;

              console.log("調整後的 GPS:", adjustedLat, adjustedLng);

              // **設定 GPS 位置**
              let arVideo = document.getElementById("ar-video");
              arVideo.setAttribute(
                "gps-entity-place",
                `latitude: ${adjustedLat}; longitude: ${adjustedLng}`
              );
            },
            function (error) {
              console.error("GPS 無法啟用", error);
              alert("請允許 GPS 存取以顯示 AR 內容");
            },
            { enableHighAccuracy: true } // **確保 GPS 讀取更精準**
          );
        } else {
          alert("您的裝置不支援 GPS");
        }
      }
      setTimeout(enableGPS, 5000); // 延遲 5 秒確保 GPS 校正

      // **確保 WebAR 正確顯示**
      function checkAR() {
        let arVideo = document.getElementById("ar-video");
        if (arVideo) {
          console.log("WebAR 影片已載入");
        } else {
          console.error("WebAR 影片未顯示");
        }
      }

      // **自動啟用 GPS & WebAR**
      setTimeout(() => {
        enableGPS();
        checkAR();
      }, 3000);
    </script>
  </body>
</html>
